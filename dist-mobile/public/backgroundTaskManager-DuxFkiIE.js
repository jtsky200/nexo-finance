import{eventBus as i,Events as s}from"./eventBus-CWDWdm45.js";class u{tasks=new Map;isRunning=!1;constructor(){this.setupVisibilityHandling(),this.setupActivityTracking()}registerTask(t){const e=t.id;return this.tasks.set(e,{...t,lastRun:void 0,timeoutId:void 0}),this.isRunning&&t.enabled&&this.scheduleTask(e),()=>{this.unregisterTask(e)}}unregisterTask(t){const e=this.tasks.get(t);e?.timeoutId&&clearTimeout(e.timeoutId),this.tasks.delete(t)}start(){this.isRunning||(this.isRunning=!0,i.emit(s.APP_READY),this.tasks.forEach((t,e)=>{t.enabled&&this.scheduleTask(e)}))}stop(){this.isRunning&&(this.isRunning=!1,i.emit(s.APP_SUSPEND),this.tasks.forEach(t=>{t.timeoutId&&(clearTimeout(t.timeoutId),t.timeoutId=void 0)}))}scheduleTask(t){const e=this.tasks.get(t);if(!e||!e.enabled||!this.isRunning)return;e.timeoutId&&clearTimeout(e.timeoutId);const n=e.lastRun?Math.max(0,e.interval-(Date.now()-e.lastRun)):0;e.timeoutId=window.setTimeout(async()=>{try{i.emit(s.BACKGROUND_TASK_START,{taskId:t,taskName:e.name}),await e.callback(),e.lastRun=Date.now(),i.emit(s.BACKGROUND_TASK_COMPLETE,{taskId:t,taskName:e.name}),this.scheduleTask(t)}catch(a){i.emit(s.BACKGROUND_TASK_ERROR,{taskId:t,taskName:e.name,error:a}),e.lastRun=Date.now(),this.scheduleTask(t)}},n)}setupVisibilityHandling(){typeof document>"u"||document.addEventListener("visibilitychange",()=>{document.hidden?i.emit(s.USER_VISIBILITY_CHANGE,{visible:!1}):(i.emit(s.USER_VISIBILITY_CHANGE,{visible:!0}),this.triggerImmediateSync())})}setupActivityTracking(){if(!(typeof window>"u"||typeof document>"u"))try{let t=null;const e=300*1e3,n=()=>{try{t&&clearTimeout(t),i.emit(s.USER_ACTIVE),t=window.setTimeout(()=>{i.emit(s.USER_IDLE)},e)}catch{}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{["mousedown","mousemove","keypress","scroll","touchstart"].forEach(a=>{try{document.addEventListener(a,n,{passive:!0})}catch{}}),n()}):(["mousedown","mousemove","keypress","scroll","touchstart"].forEach(a=>{try{document.addEventListener(a,n,{passive:!0})}catch{}}),n())}catch{}}triggerImmediateSync(){this.tasks.forEach((t,e)=>{t.enabled&&(e.includes("reminder")||e.includes("sync"))&&(t.lastRun=void 0,this.scheduleTask(e))})}getAllTasksStatus(){return Array.from(this.tasks.entries()).map(([t,e])=>({id:t,name:e.name,enabled:e.enabled,lastRun:e.lastRun,nextRun:e.lastRun?e.lastRun+e.interval:void 0}))}}const o=new u;typeof window<"u"&&setTimeout(()=>{o.start()},1e3);export{o as backgroundTaskManager};
