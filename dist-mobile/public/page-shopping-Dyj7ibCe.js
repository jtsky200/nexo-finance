import{u as Et,h as Lt,j as e,I as Ze,S as Je,i as Xe,k as et,l as tt,m as E,B as me,n as Pe,o as Z,p as y,q as It,r as Tt,s as L,t as st,f as Ee,v as Rt}from"./page-aichat-NBZWpoUt.js";import{useEffect as ue,useState as l,useRef as xe,useMemo as at}from"react";import{M as zt}from"./page-calendar-P_Pe8_3s.js";import{t as r}from"./vendor-toast-CdQ6zwVl.js";import{j as Le}from"./vendor-firebase-BWRlcouJ.js";import{j as Ie,m as J,J as rt,X,K as Mt,i as he,H as $t,D as Te,R as Dt,F as qt,N as Kt,n as Re,l as ze,f as Ht,v as Bt,O as nt,p as it,Q as Ot,V as Ut}from"./vendor-misc-BL476KuS.js";const Vt=["Lebensmittel","Getränke","Haushalt","Hygiene","Tierbedarf","Sonstiges"];function os(){const{t:A}=Et();ue(()=>{const t=document.createElement("style");return t.textContent=`
      @keyframes scan-line {
        0% { transform: translateY(0); opacity: 0.3; }
        50% { transform: translateY(100%); opacity: 1; }
        100% { transform: translateY(0); opacity: 0.3; }
      }
    `,document.head.appendChild(t),()=>document.head.removeChild(t)},[]);const{data:ee=[],isLoading:lt,refetch:I}=Lt(),[Me,fe]=l(!1),[h,D]=l({name:"",quantity:"1",category:"Lebensmittel",store:""}),[$e,De]=l(!1),[q,T]=l("camera"),[R,te]=l("receipt"),[x,F]=l(!1),[n,ge]=l(null),[b,z]=l([]),[p,C]=l([]),[ct,S]=l(0),[j,se]=l(null),[K,H]=l(1),[be,ot]=l(!0),[pe,dt]=l(!0),[je,mt]=l(!0),d=xe(null),M=xe(null),qe=xe(null),[c,B]=l(null),Ne=at(()=>ee.filter(t=>!t.bought),[ee]),ae=at(()=>ee.filter(t=>t.bought),[ee]),ut=async()=>{if(!h.name.trim()){r.error("Bitte Artikelname eingeben");return}try{await Pe({name:h.name.trim(),quantity:parseInt(h.quantity)||1,category:h.category,store:h.store||void 0,bought:!1}),r.success("Artikel hinzugefügt"),Z(),fe(!1),D({name:"",quantity:"1",category:"Lebensmittel",store:""}),await I()}catch(t){r.error("Fehler: "+t.message),y()}},Ke=async(t,s)=>{try{await It(t,!s),Tt(),await I()}catch(a){r.error(L(a)),y()}},xt=async t=>{try{await st(t),Z(),await I()}catch(s){r.error(L(s)),y()}},ht=async()=>{try{for(const t of ae)await st(t.id);r.success("Eingekaufte Artikel gelöscht"),Z(),await I()}catch(t){r.error(L(t)),y()}},[Qt,O]=l("idle"),[_t,He]=l(0),v=xe(null),[Gt,ft]=l({topLeft:{x:10,y:15},topRight:{x:90,y:15},bottomLeft:{x:10,y:75},bottomRight:{x:90,y:75}}),[Wt,Yt]=l(null),[Zt,Jt]=l(!1),U=async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){r.error("Kamera wird nicht unterstützt"),T("upload");return}c&&(c.getTracks().forEach(a=>{a.stop()}),B(null),await new Promise(a=>setTimeout(a,100))),d.current&&(d.current.srcObject=null);let t=null,s={video:{facingMode:"environment",width:{ideal:3840},height:{ideal:2160},aspectRatio:{ideal:16/9}},audio:!1};try{t=await navigator.mediaDevices.getUserMedia(s)}catch{s={video:{facingMode:"environment",width:{ideal:1920},height:{ideal:1080}},audio:!1};try{t=await navigator.mediaDevices.getUserMedia(s)}catch{t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1})}}if(!t||t.getVideoTracks().length===0)throw new Error("Kein Kamera-Stream erhalten");if(B(t),O("scanning"),await new Promise(a=>setTimeout(a,50)),d.current){const a=d.current;a.srcObject=t,await new Promise((i,m)=>{const o=setTimeout(()=>{m(new Error("Video-Timeout"))},5e3),N=()=>{clearTimeout(o),a.removeEventListener("loadedmetadata",N),a.removeEventListener("error",$),i()},$=Ce=>{clearTimeout(o),a.removeEventListener("loadedmetadata",N),a.removeEventListener("error",$),m(new Error("Video-Fehler"))};if(a.readyState>=2){clearTimeout(o),i();return}a.addEventListener("loadedmetadata",N,{once:!0}),a.addEventListener("error",$,{once:!0})});try{await a.play(),r.success("Kamera aktiv"),Be()}catch{r.success("Kamera aktiv"),Be()}}}catch(t){c&&(c.getTracks().forEach(i=>i.stop()),B(null)),d.current&&(d.current.srcObject=null);const s=t;let a="Kamera-Fehler";s.name==="NotAllowedError"||s.name==="PermissionDeniedError"?a="Kamera-Berechtigung verweigert. Bitte in den Browser-Einstellungen erlauben.":s.name==="NotFoundError"||s.name==="DevicesNotFoundError"?a="Keine Kamera gefunden":s.name==="NotReadableError"||s.name==="TrackStartError"?a="Kamera wird bereits verwendet":s.name==="OverconstrainedError"||s.name==="ConstraintNotSatisfiedError"?a="Kamera-Unterstützung nicht verfügbar":s.message==="Video-Timeout"?a="Kamera-Initialisierung zu langsam":a=`Kamera-Fehler: ${s.message||s.name}`,r.error(a),T("upload"),O("idle")}},we=()=>{v.current&&(cancelAnimationFrame(v.current),v.current=null),c&&(c.getTracks().forEach(t=>t.stop()),B(null)),O("idle"),He(0)},Be=()=>{ft({topLeft:{x:15,y:10},topRight:{x:85,y:10},bottomLeft:{x:15,y:85},bottomRight:{x:85,y:85}}),O("scanning"),He(0)},gt=()=>{if(!d.current||!M.current)return;v.current&&(cancelAnimationFrame(v.current),v.current=null),O("capturing");const t=d.current,s=M.current;s.width=t.videoWidth,s.height=t.videoHeight;const a=s.getContext("2d");a&&(a.imageSmoothingEnabled=!1,a.drawImage(t,0,0),r.success("Foto aufgenommen!"),s.toBlob(async i=>{if(i){we();const m=new File([i],"photo.jpg",{type:"image/jpeg"});await Oe(m)}},"image/jpeg",1))};ue(()=>()=>{!c&&d.current&&d.current.srcObject&&(d.current.srcObject.getTracks().forEach(s=>s.stop()),d.current.srcObject=null)},[c]),ue(()=>()=>{v.current&&(cancelAnimationFrame(v.current),v.current=null),c&&(c.getTracks().forEach(t=>t.stop()),B(null)),d.current&&(d.current.srcObject=null)},[]);const bt=async t=>{const s=t.target.files?.[0];s&&await Oe(s)},Oe=async t=>{F(!0),z([]),ge(null);try{const s=new FileReader;s.onload=async()=>{try{const a=s.result.split(",")[1];r.info("Analysiere mit OCR...");const o=(await Le(Ee,"analyzeReceipt")({fileData:a,fileType:t.type||"image/jpeg",fileName:t.name||"photo.jpg"})).data;o.success&&o.items&&o.items.length>0?(ge({store:o.store||{name:"Unbekannt"},purchase:o.purchase||{},items:o.items,totals:o.totals||{total:0},confidence:o.confidence||50}),z(o.items.map(N=>({...N,selected:!0}))),r.success(`${o.items.length} Artikel erkannt!`)):o.error?.includes("Vision API")||o.error?.includes("PERMISSION_DENIED")?r.error("OCR nicht verfügbar. Google Cloud Vision API muss aktiviert werden.",{duration:5e3}):o.error?.includes("billing")?r.error("Google Cloud Billing erforderlich",{duration:5e3}):o.rawText?r.error("Text erkannt aber keine Artikel gefunden. Versuche bessere Bildqualität.",{duration:4e3}):r.error(o.error||"Keine Artikel erkannt. Bitte bessere Bildqualität verwenden.",{duration:4e3})}catch(a){r.error(L(a)),y()}F(!1)},s.onerror=()=>{r.error("Datei konnte nicht gelesen werden"),y(),F(!1)},s.readAsDataURL(t)}catch(s){r.error(L(s)),y(),F(!1)}},[ye,V]=l(null),[f,Ue]=l(!1),[re,ne]=l(null),[pt,jt]=l(0),[ve,Q]=l(new Set),[Xt,Nt]=l([]),ke=async()=>{if(!d.current||!M.current||x)return;const t=Date.now();if(t-pt<1500)return;jt(t),F(!0),V(null);const s=d.current,a=M.current,i=s.videoWidth||1920,m=s.videoHeight||1080,o=Math.max(i,1920),N=Math.max(m,1080);a.width=o,a.height=N;const $=a.getContext("2d",{willReadFrequently:!0,alpha:!1});$&&($.drawImage(s,0,0,i,m,0,0,o,N),a.toBlob(async Ce=>{if(Ce)try{const ie=new FileReader;ie.onload=async()=>{const Pt=ie.result.split(",")[1];try{const G=(await Le(Ee,"analyzeReceipt")({fileData:Pt,fileType:"image/jpeg",fileName:"live-scan-full.jpg"})).data;if(G.success&&G.items&&G.items.length>0){const Se=(G.rawText||"").split(/[\n\r]+/),le=G.items.map((u,k)=>{const ce=(u.name||"Unbekannt").toLowerCase().trim(),W=(u.unitPrice||u.totalPrice||0).toFixed(2),P=u.articleNumber||"";let Y=-1;for(let w=0;w<Se.length;w++)if(Se[w].includes(u.name||"")||P&&Se[w].includes(P)){Y=w;break}const g=`${ce}_${W}_${P}_${Y>=0?Y:k}_${k}`;return{item:{name:u.name||"Unbekannt",articleNumber:u.articleNumber,quantity:u.quantity||1,unitPrice:u.unitPrice||u.totalPrice||0,totalPrice:u.totalPrice||u.unitPrice*(u.quantity||1),selected:!0},positionId:g}}).filter(({positionId:u})=>!ve.has(u));if(le.length>0){const u=new Set(ve);le.forEach(({positionId:k})=>{u.add(k)}),Q(u),C(k=>{const ce=new Set(k.map(g=>{const w=g.name.toLowerCase().trim(),oe=g.unitPrice.toFixed(2),Ae=g.articleNumber||"";return`${w}_${oe}_${Ae}`})),W=[...k];let P=0;le.forEach(({item:g,positionId:w})=>{const oe=g.name.toLowerCase().trim(),Ae=g.unitPrice.toFixed(2),Fe=g.articleNumber||"",Ye=`${oe}_${Ae}_${Fe}`;ce.has(Ye)||Fe&&k.some(de=>de.articleNumber===Fe)||k.some(de=>de.name.toLowerCase().trim()===oe&&Math.abs(de.unitPrice-g.unitPrice)<.01)||(W.push(g),P++,ce.add(Ye))});const Y=W.reduce((g,w)=>g+w.totalPrice,0);return S(Y),P>0?(r.success(`${P} neue Artikel erkannt!`,{duration:1500}),navigator.vibrate&&navigator.vibrate(200)):le.length>0&&(f||r.info("Alle Artikel bereits in Liste",{duration:1e3})),W})}else f||r.info("Alle Artikel bereits erkannt",{duration:1e3})}else f||V("Keine Artikel erkannt")}catch(Ge){if(!f){const We=L(Ge);V(We)}y()}F(!1)},ie.readAsDataURL(Ce)}catch{y(),F(!1)}},"image/jpeg",.95))};ue(()=>{if(f&&c&&R==="single"){const t=setTimeout(()=>{!x&&c&&ke()},500),s=setInterval(()=>{!x&&c&&ke()},2e3);return ne(s),()=>{clearInterval(s),clearTimeout(t),ne(null)}}else re&&(clearInterval(re),ne(null))},[f,c,R,x]);const wt=async()=>{await ke()},yt=()=>{if(!j)return;const t={...j,quantity:K,totalPrice:j.unitPrice*K};C(s=>[...s,t]),S(s=>s+t.totalPrice),se(null),H(1),r.success(`${t.name} (${K}x) hinzugefügt`),Z()},vt=()=>{se(null),H(1)},Ve=t=>{C(s=>{const a=s[t];return S(i=>i-a.totalPrice),s.filter((i,m)=>m!==t)})},Qe=(t,s)=>{if(s<1){Ve(t);return}C(a=>{const i=[...a],m=i[t],o=m.totalPrice;return i[t]={...m,quantity:s,totalPrice:m.unitPrice*s},S(N=>N-o+i[t].totalPrice),i})},kt=async()=>{if(p.length===0){r.error("Keine Artikel gescannt");return}try{for(const t of p)await Pe({name:t.name,quantity:t.quantity||1,category:_e(t.name),store:n?.store?.name||"",bought:!1});r.success(`${p.length} Artikel hinzugefügt!`),C([]),S(0),_(),await I()}catch(t){r.error("Fehler: "+t.message)}},Ct=async()=>{const t=b.filter(s=>s.selected);if(t.length===0){r.error("Bitte mindestens einen Artikel auswählen");return}try{for(const s of t)await Pe({name:s.name,quantity:s.quantity||1,category:_e(s.name),store:n?.store?.name||"",bought:!1});r.success(`${t.length} Artikel hinzugefügt!`),_(),await I()}catch(s){r.error("Fehler: "+s.message)}},St=async()=>{if(n)try{await Le(Ee,"saveReceipt")({receiptData:n}),r.success("Quittung gespeichert!")}catch(t){r.error("Fehler: "+t.message)}},At=async()=>{if(n)try{await Rt({type:"expense",amount:n.totals.total*100,category:"Lebensmittel",description:`Einkauf bei ${n.store.name}`,date:n.purchase.date||new Date().toISOString().split("T")[0],paymentMethod:n.purchase.paymentMethod||"Karte",status:"bezahlt"}),r.success("Zu Finanzen hinzugefügt!"),Z(),_()}catch(t){r.error(L(t)),y()}},_e=t=>{const s=t.toLowerCase(),a={Getränke:["bier","wein","saft","wasser","cola","fanta","sprite","energy","shot","drink"],"Obst & Gemüse":["apfel","orange","banane","tomate","salat","gurke","karotte","bio oran","gemüse"],Milchprodukte:["milch","joghurt","käse","butter","sahne","quark","naturejog"],Fleisch:["fleisch","steak","wurst","schinken","poulet","rind","schwein","ragout"],Backwaren:["brot","brötchen","toast","croissant","kuchen","keks","butterkeks"],Süsswaren:["schoko","bonbon","gummi","chips","zucker","gelatine"]};for(const[i,m]of Object.entries(a))if(m.some(o=>s.includes(o)))return i;return"Lebensmittel"},Ft=()=>{De(!0),z([]),T("camera"),setTimeout(()=>U(),100)},_=()=>{we(),De(!1),z([]),ge(null),C([]),S(0),te("receipt"),se(null),H(1),V(null),Ue(!1),Q(new Set),Nt([]),re&&(clearInterval(re),ne(null))};return e.jsxs(zt,{title:A("nav.shopping","Einkaufsliste"),showSidebar:!0,children:[e.jsxs("div",{className:"mobile-card mb-4 bg-primary text-primary-foreground",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(Ie,{className:"w-6 h-6 opacity-70"}),e.jsx("p",{className:"text-sm opacity-70 font-medium",children:A("shopping.list","Einkaufsliste")})]}),e.jsx("p",{className:"text-3xl font-semibold mb-2",children:Ne.length}),e.jsx("p",{className:"text-sm opacity-60",children:A("shopping.itemsOpen","Artikel offen")})]}),lt?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:A("common.loading","Laden...")}):Ne.length===0?e.jsxs("div",{className:"mobile-card text-center py-8",children:[e.jsx(J,{className:"w-10 h-10 mx-auto status-success mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:A("shopping.empty","Liste ist leer")})]}):e.jsx("div",{className:"space-y-3 mb-4",children:Ne.map(t=>e.jsxs("div",{className:"mobile-card flex items-center gap-4 py-3",children:[e.jsx("button",{onClick:()=>Ke(t.id,t.bought),className:"w-6 h-6 rounded border-2 border-border flex items-center justify-center shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.quantity>1&&`${t.quantity}x • `,t.category,t.store&&` • ${t.store}`]})]}),e.jsx("button",{onClick:()=>xt(t.id),className:"w-10 h-10 rounded-lg flex items-center justify-center text-muted-foreground active:opacity-80",children:e.jsx(rt,{className:"w-4 h-4"})})]},t.id))}),ae.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("p",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:[A("shopping.bought","Eingekauft")," (",ae.length,")"]}),e.jsx("button",{onClick:ht,className:"text-xs status-error active:opacity-80",children:A("shopping.clearBought","Löschen")})]}),e.jsx("div",{className:"space-y-3 opacity-60",children:ae.map(t=>e.jsxs("div",{className:"mobile-card flex items-center gap-4 py-3",children:[e.jsx("button",{onClick:()=>Ke(t.id,t.bought),className:"w-6 h-6 rounded bg-status-success flex items-center justify-center shrink-0",children:e.jsx(J,{className:"w-4 h-4 status-success"})}),e.jsx("p",{className:"font-medium line-through flex-1 truncate",children:t.name})]},t.id))})]}),Me&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-end",children:e.jsxs("div",{className:"bg-background w-full rounded-t-2xl p-6 safe-bottom animate-in slide-in-from-bottom",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Artikel hinzufügen"}),e.jsx("button",{onClick:()=>fe(!1),className:"w-10 h-10 rounded-lg bg-muted flex items-center justify-center",children:e.jsx(X,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{children:e.jsx(Ze,{value:h.name,onChange:t=>D({...h,name:t.target.value}),placeholder:"Artikelname",className:"mobile-input",autoFocus:!0})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"w-20",children:e.jsx(Ze,{type:"number",value:h.quantity,onChange:t=>D({...h,quantity:t.target.value}),placeholder:"1",className:"mobile-input text-center",min:"1"})}),e.jsx("div",{className:"flex-1",children:e.jsxs(Je,{value:h.category,onValueChange:t=>D({...h,category:t}),children:[e.jsx(Xe,{className:"mobile-input",children:e.jsx(et,{})}),e.jsx(tt,{children:Vt.map(t=>e.jsx(E,{value:t,children:t},t))})]})})]}),e.jsx("div",{children:e.jsxs(Je,{value:h.store||"none",onValueChange:t=>D({...h,store:t==="none"?"":t}),children:[e.jsx(Xe,{className:"mobile-input",children:e.jsx(et,{placeholder:"Laden (optional)"})}),e.jsxs(tt,{children:[e.jsx(E,{value:"none",children:"Kein Laden"}),e.jsx(E,{value:"Migros",children:"Migros"}),e.jsx(E,{value:"Coop",children:"Coop"}),e.jsx(E,{value:"Aldi",children:"Aldi"}),e.jsx(E,{value:"Lidl",children:"Lidl"}),e.jsx(E,{value:"Denner",children:"Denner"})]})]})}),e.jsx(me,{onClick:ut,className:"w-full mobile-btn bg-primary text-primary-foreground mt-4",children:"Hinzufügen"})]})]})}),$e&&e.jsxs("div",{className:"fixed inset-0 z-50 bg-black flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-black/50",children:[e.jsx("h2",{className:"text-white font-semibold",children:"Liste scannen"}),e.jsx("button",{onClick:_,className:"w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center",children:e.jsx(X,{className:"w-5 h-5 text-white"})})]}),e.jsxs("div",{className:"flex gap-2 px-4 py-2",children:[e.jsxs("button",{onClick:()=>{te("receipt"),T("camera"),U()},className:`flex-1 py-2 px-3 rounded-lg flex items-center justify-center gap-1.5 text-sm ${R==="receipt"&&q==="camera"?"bg-white text-black":"bg-white/20 text-white"}`,children:[e.jsx(Mt,{className:"w-4 h-4"}),"Quittung"]}),e.jsxs("button",{onClick:async()=>{te("single"),T("camera"),C([]),S(0),Q(new Set),se(null),V(null),await U()},className:`flex-1 py-2 px-3 rounded-lg flex items-center justify-center gap-1.5 text-sm ${R==="single"?"bg-white text-black":"bg-white/20 text-white"}`,children:[e.jsx(he,{className:"w-4 h-4"}),"Einzeln"]}),e.jsxs("button",{onClick:()=>{te("receipt"),T("upload"),we()},className:`flex-1 py-2 px-3 rounded-lg flex items-center justify-center gap-1.5 text-sm ${q==="upload"?"bg-white text-black":"bg-white/20 text-white"}`,children:[e.jsx($t,{className:"w-4 h-4"}),"Upload"]})]}),q==="camera"&&R==="receipt"&&b.length===0&&e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("video",{ref:d,autoPlay:!0,playsInline:!0,muted:!0,preload:"auto",className:"absolute inset-0 w-full h-full object-cover"}),e.jsx("canvas",{ref:M,className:"hidden"}),c&&e.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[e.jsx("div",{className:"absolute inset-8 border-2 border-white/60 rounded-lg"}),e.jsx("div",{className:"absolute top-8 left-8 w-6 h-6 border-t-4 border-l-4 border-white rounded-tl"}),e.jsx("div",{className:"absolute top-8 right-8 w-6 h-6 border-t-4 border-r-4 border-white rounded-tr"}),e.jsx("div",{className:"absolute bottom-8 left-8 w-6 h-6 border-b-4 border-l-4 border-white rounded-bl"}),e.jsx("div",{className:"absolute bottom-8 right-8 w-6 h-6 border-b-4 border-r-4 border-white rounded-br"})]}),e.jsx("div",{className:"absolute top-4 left-4 right-4 z-20",children:e.jsx("div",{className:"bg-black/60 rounded-lg p-3 text-center",children:e.jsx("p",{className:"text-white text-sm font-medium",children:x?"Analysiere...":"Quittung fotografieren"})})}),e.jsx("div",{className:"absolute bottom-8 left-0 right-0 z-20",children:c?e.jsxs("div",{className:"flex justify-center items-center gap-4",children:[e.jsx("button",{onClick:_,className:"w-12 h-12 rounded-full bg-white/20 flex items-center justify-center active:opacity-80",children:e.jsx(X,{className:"w-6 h-6 text-white"})}),e.jsx("button",{onClick:gt,disabled:x,className:"w-20 h-20 rounded-full bg-white shadow-lg flex items-center justify-center active:opacity-80 border-4 border-white/50",children:x?e.jsx("div",{className:"w-8 h-8 border-3 border-gray-300 border-t-gray-600 rounded-full animate-spin"}):e.jsx("div",{className:"w-14 h-14 rounded-full bg-white"})}),e.jsx("div",{className:"w-12 h-12"})]}):e.jsx("div",{className:"flex justify-center",children:e.jsxs("button",{onClick:U,className:"px-6 py-3 rounded-full bg-white shadow-lg flex items-center justify-center gap-2 active:opacity-80",children:[e.jsx(Te,{className:"w-5 h-5 text-gray-800"}),e.jsx("span",{className:"font-medium text-gray-800",children:"Kamera starten"})]})})})]}),q==="camera"&&R==="single"&&e.jsxs("div",{className:"flex-1 flex flex-col bg-background w-full h-full overflow-hidden",children:[e.jsx("div",{className:"w-full px-4 py-3 bg-background/95 backdrop-blur-sm border-b border-border/50 flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${c?"bg-green-500 animate-pulse":"bg-gray-400"}`}),e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:c?"Kamera aktiv":"Kamera inaktiv"})]}),e.jsx("p",{className:"text-sm font-bold truncate",children:x?"Analysiere...":f?`${ve.size} Positionen erkannt`:p.length>0?`${p.length} Artikel gescannt`:"Bereit zum Scannen"})]}),e.jsxs("button",{onClick:()=>Ue(!f),disabled:!c,className:`px-3 py-2 rounded-lg flex items-center gap-1.5 flex-shrink-0 transition-all ${f&&c?"bg-green-500 text-white shadow-lg":"bg-muted text-muted-foreground"} ${c?"":"opacity-50"}`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${f&&c?"bg-white":"bg-foreground/50"}`}),e.jsx("span",{className:"text-xs font-semibold",children:"Auto"})]})]})}),e.jsxs("div",{className:"flex-1 flex flex-col w-full overflow-hidden min-h-0 relative",children:[e.jsxs("div",{className:"relative bg-black w-full flex-1 flex-shrink-0 min-h-0",children:[e.jsx("video",{ref:d,autoPlay:!0,playsInline:!0,muted:!0,preload:"auto",className:"absolute inset-0 w-full h-full object-cover",style:{minWidth:"100%",minHeight:"100%"}}),e.jsx("canvas",{ref:M,className:"hidden"}),c&&f&&e.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[x&&e.jsx("div",{className:"absolute left-0 right-0 h-1 bg-green-500/50",style:{top:"50%",animation:"scan-line 1.5s ease-in-out infinite",boxShadow:"0 0 20px rgba(16, 185, 129, 0.6)",transform:"translateY(-50%)"}}),e.jsx("div",{className:"absolute top-4 left-1/2 transform -translate-x-1/2 z-10",children:e.jsxs("div",{className:"bg-green-500/90 backdrop-blur-sm text-white px-4 py-2 rounded-full text-xs font-semibold flex items-center gap-2 shadow-lg",children:[e.jsx("div",{className:"w-2 h-2 bg-white rounded-full animate-pulse"}),x?"Analysiere...":`Live-Scan (${p.length} Artikel)`]})})]}),c&&!f&&e.jsx("div",{className:"absolute top-4 left-1/2 transform -translate-x-1/2 z-10",children:e.jsx("div",{className:"bg-black/60 backdrop-blur-sm text-white px-4 py-2 rounded-full text-xs font-medium",children:"Quittung vollständig sichtbar machen"})}),c&&!j&&e.jsx("div",{className:"absolute bottom-0 left-0 right-0 z-20 p-4 bg-gradient-to-t from-black/80 via-black/40 to-transparent",children:e.jsx("button",{onClick:wt,disabled:x,className:`w-full py-4 rounded-xl shadow-2xl flex items-center justify-center gap-3 transition-all transform ${x?"bg-gray-600/90":"bg-green-500 hover:bg-green-600 active:scale-95"}`,children:x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-6 h-6 border-2 border-white/30 border-t-white rounded-full animate-spin"}),e.jsx("span",{className:"font-bold text-white text-lg",children:"Analysiere..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"w-6 h-6 text-white"}),e.jsx("span",{className:"font-bold text-white text-lg",children:"ALLE SCANNEN"})]})})}),!c&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-b from-black/90 to-black/70",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"w-20 h-20 mx-auto mb-4 rounded-full bg-white/10 backdrop-blur-sm flex items-center justify-center",children:e.jsx(Te,{className:"w-10 h-10 text-white"})}),e.jsx("p",{className:"text-white text-lg font-semibold mb-2",children:"Kamera starten"}),e.jsx("p",{className:"text-white/70 text-sm",children:"Für das Scannen von Quittungen"})]}),e.jsxs("button",{onClick:U,className:"px-8 py-4 rounded-xl bg-white shadow-2xl flex items-center justify-center gap-3 hover:bg-gray-50 active:scale-95 transition-all",children:[e.jsx(Te,{className:"w-6 h-6 text-gray-800"}),e.jsx("span",{className:"font-bold text-gray-800 text-base",children:"Kamera aktivieren"})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto bg-background w-full p-4 min-h-0",children:[ye&&!j&&e.jsxs("div",{className:"mb-4 p-4 bg-red-500/10 border border-red-500/30 rounded-xl backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),e.jsx("p",{className:"text-red-600 font-semibold text-sm",children:"Fehler"})]}),e.jsx("p",{className:"text-red-600 font-medium text-center text-sm",children:ye}),e.jsx("p",{className:"text-red-500/70 text-xs text-center mt-1",children:"Quittung näher halten und erneut scannen"})]}),j&&e.jsxs("div",{className:"mb-4 p-5 bg-green-500/10 border border-green-500/40 rounded-xl backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500 animate-pulse"}),e.jsx("p",{className:"text-green-600 font-bold text-sm",children:"ERKANNT"})]}),e.jsxs("div",{className:"bg-background/80 backdrop-blur-sm rounded-lg p-4 mb-4 border border-border/50",children:[e.jsx("p",{className:"font-bold text-base mb-1",children:j.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["CHF ",j.unitPrice.toFixed(2)," pro Stück"]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-4 mb-4",children:[e.jsx("button",{onClick:()=>H(t=>Math.max(1,t-1)),className:"w-11 h-11 rounded-full bg-muted flex items-center justify-center text-xl font-bold active:scale-95 transition-transform",children:"−"}),e.jsx("div",{className:"w-16 h-11 rounded-lg bg-background border border-border flex items-center justify-center",children:e.jsx("span",{className:"text-2xl font-bold",children:K})}),e.jsx("button",{onClick:()=>H(t=>t+1),className:"w-11 h-11 rounded-full bg-muted flex items-center justify-center text-xl font-bold active:scale-95 transition-transform",children:"+"})]}),e.jsxs("div",{className:"text-center mb-4 p-3 bg-background/50 rounded-lg border border-border/50",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Total"}),e.jsxs("p",{className:"text-xl font-bold",children:["CHF ",(j.unitPrice*K).toFixed(2)]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:vt,className:"flex-1 py-3 rounded-lg bg-muted flex items-center justify-center gap-2 text-sm font-semibold active:scale-95 transition-transform",children:[e.jsx(X,{className:"w-4 h-4"}),"Abbrechen"]}),e.jsxs("button",{onClick:yt,className:"flex-1 py-3 rounded-lg bg-green-500 text-white flex items-center justify-center gap-2 text-sm font-semibold shadow-lg active:scale-95 transition-transform",children:[e.jsx(J,{className:"w-4 h-4"}),"Hinzufügen"]})]})]}),!j&&p.length===0&&!ye&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full bg-muted/50 flex items-center justify-center",children:e.jsx(he,{className:"w-8 h-8 text-muted-foreground/40"})}),e.jsx("p",{className:"text-base font-bold text-foreground mb-2",children:"Artikel scannen"}),e.jsx("p",{className:"text-xs text-muted-foreground/70 px-4",children:f?e.jsx(e.Fragment,{children:"Auto-Scan aktiv: Quittung in den Rahmen halten"}):e.jsx(e.Fragment,{children:'Quittung in den Rahmen halten und "ALLE SCANNEN" drücken'})})]}),p.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3 p-3 bg-green-500/10 rounded-xl border border-green-500/30 backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center",children:e.jsx(Ie,{className:"w-4 h-4 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Gesamt"}),e.jsxs("p",{className:"font-bold text-sm",children:[p.reduce((t,s)=>t+s.quantity,0)," Artikel"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total"}),e.jsxs("p",{className:"text-xl font-bold text-green-600",children:["CHF ",ct.toFixed(2)]})]})]}),e.jsx("div",{className:"space-y-2.5 mb-3",children:p.map((t,s)=>e.jsxs("div",{className:"p-3 bg-muted/80 backdrop-blur-sm rounded-xl border border-border/50",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2.5 flex-1 min-w-0",children:[e.jsx("div",{className:"w-9 h-9 rounded-full bg-green-500 text-white text-xs font-bold flex items-center justify-center flex-shrink-0 shadow-sm",children:t.quantity}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-bold text-sm mb-0.5 truncate",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["CHF ",t.unitPrice.toFixed(2)," pro Stück"]})]})]}),e.jsx("button",{onClick:()=>Ve(s),className:"w-8 h-8 rounded-full bg-red-500/10 flex items-center justify-center flex-shrink-0 active:scale-95 transition-transform",children:e.jsx(X,{className:"w-4 h-4 text-red-500"})})]}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Qe(s,t.quantity-1),className:"w-9 h-9 rounded-full bg-background border border-border flex items-center justify-center text-lg font-bold active:scale-95 transition-transform",children:"−"}),e.jsx("div",{className:"w-10 h-9 rounded-lg bg-background border border-border flex items-center justify-center",children:e.jsx("span",{className:"text-lg font-bold",children:t.quantity})}),e.jsx("button",{onClick:()=>Qe(s,t.quantity+1),className:"w-9 h-9 rounded-full bg-background border border-border flex items-center justify-center text-lg font-bold active:scale-95 transition-transform",children:"+"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total"}),e.jsxs("p",{className:"font-bold text-base",children:["CHF ",t.totalPrice.toFixed(2)]})]})]})]},s))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{Q(new Set),r.success("Positionen zurückgesetzt")},className:"px-3 py-2.5 rounded-lg bg-muted flex items-center justify-center gap-1.5 text-xs font-semibold active:scale-95 transition-transform",children:[e.jsx(Dt,{className:"w-3.5 h-3.5"}),"Reset"]}),e.jsxs("button",{onClick:()=>{C([]),S(0),Q(new Set)},className:"flex-1 py-2.5 rounded-lg bg-muted flex items-center justify-center gap-1.5 text-xs font-semibold active:scale-95 transition-transform",children:[e.jsx(rt,{className:"w-3.5 h-3.5"}),"Alle löschen"]}),e.jsxs("button",{onClick:kt,className:"flex-1 py-2.5 rounded-lg bg-primary text-primary-foreground flex items-center justify-center gap-1.5 text-xs font-semibold shadow-lg active:scale-95 transition-transform",children:[e.jsx(J,{className:"w-3.5 h-3.5"}),"Fertig"]})]})]})]})]})]}),q==="upload"&&b.length===0&&e.jsxs("div",{className:"flex-1 flex items-center justify-center p-4",children:[e.jsxs("button",{onClick:()=>qe.current?.click(),className:"w-full max-w-sm p-8 border-2 border-dashed border-white/30 rounded-xl text-center",children:[e.jsx(qt,{className:"w-12 h-12 mx-auto text-white/50 mb-4"}),e.jsx("p",{className:"text-white font-medium",children:"Foto auswählen"}),e.jsx("p",{className:"text-white/50 text-sm mt-2",children:"JPG, PNG oder PDF"})]}),e.jsx("input",{ref:qe,type:"file",accept:"image/*,application/pdf",capture:"environment",className:"hidden",onChange:bt})]}),x&&e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-12 h-12 border-2 border-white/30 border-t-white rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-white",children:"Analysiere Liste..."})]})}),n&&b.length>0&&e.jsx("div",{className:"flex-1 bg-background overflow-y-auto",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"bg-muted rounded-xl overflow-hidden",children:[e.jsxs("button",{onClick:()=>ot(!be),className:"w-full p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Kt,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-medium",children:"Geschäft"})]}),be?e.jsx(Re,{className:"w-4 h-4"}):e.jsx(ze,{className:"w-4 h-4"})]}),be&&e.jsxs("div",{className:"px-3 pb-3 space-y-1",children:[e.jsx("p",{className:"font-semibold text-lg",children:n.store.name}),n.store.address&&e.jsx("p",{className:"text-sm text-muted-foreground",children:n.store.address}),n.store.city&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[n.store.postalCode," ",n.store.city]}),e.jsxs("div",{className:"flex gap-4 mt-2 text-xs text-muted-foreground",children:[n.purchase.date&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ht,{className:"w-3 h-3"}),new Date(n.purchase.date).toLocaleDateString("de-CH")]}),n.purchase.time&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Bt,{className:"w-3 h-3"}),n.purchase.time]})]})]})]}),e.jsxs("div",{className:"bg-muted rounded-xl overflow-hidden",children:[e.jsxs("button",{onClick:()=>dt(!pe),className:"w-full p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"w-4 h-4 text-primary"}),e.jsxs("span",{className:"font-medium",children:["Artikel (",b.length,")"]}),e.jsxs("span",{className:"text-xs bg-primary text-primary-foreground px-2 py-0.5 rounded-full",children:[b.filter(t=>t.selected).length," ausgewählt"]})]}),pe?e.jsx(Re,{className:"w-4 h-4"}):e.jsx(ze,{className:"w-4 h-4"})]}),pe&&e.jsxs("div",{className:"px-3 pb-3",children:[e.jsx("div",{className:"flex justify-end mb-2",children:e.jsx("button",{onClick:()=>z(t=>t.map(s=>({...s,selected:!b.every(a=>a.selected)}))),className:"text-xs text-primary",children:b.every(t=>t.selected)?"Alle abwählen":"Alle auswählen"})}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:b.map((t,s)=>e.jsx("div",{className:`p-2.5 rounded-lg border ${t.selected?"bg-background border-primary":"bg-background/50 border-border"}`,onClick:()=>z(a=>a.map((i,m)=>m===s?{...i,selected:!i.selected}:i)),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-5 h-5 rounded border-2 ${t.selected?"bg-primary border-primary":"border-border"} flex items-center justify-center shrink-0`,children:t.selected&&e.jsx(J,{className:"w-3 h-3 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.articleNumber&&e.jsxs("span",{className:"mr-2",children:["#",t.articleNumber]}),t.quantity,"x à CHF ",t.unitPrice.toFixed(2)]})]}),e.jsxs("p",{className:"font-semibold text-sm shrink-0",children:["CHF ",t.totalPrice.toFixed(2)]})]})},s))})]})]}),e.jsxs("div",{className:"bg-muted rounded-xl overflow-hidden",children:[e.jsxs("button",{onClick:()=>mt(!je),className:"w-full p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nt,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-medium",children:"Zahlung"})]}),je?e.jsx(Re,{className:"w-4 h-4"}):e.jsx(ze,{className:"w-4 h-4"})]}),je&&e.jsxs("div",{className:"px-3 pb-3 space-y-2",children:[n.totals.subtotal&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Zwischensumme"}),e.jsxs("span",{children:["CHF ",n.totals.subtotal.toFixed(2)]})]}),n.totals.rounding&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Rundung"}),e.jsxs("span",{children:["CHF ",n.totals.rounding.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between font-semibold text-lg pt-2 border-t",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["CHF ",n.totals.total.toFixed(2)]})]}),n.purchase.paymentMethod&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(nt,{className:"w-3 h-3"}),n.purchase.paymentMethod]})]})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-muted-foreground",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${n.confidence>=70?"bg-green-500":n.confidence>=40?"bg-yellow-500":"bg-red-500"}`}),"Erkennungsqualität: ",n.confidence,"%"]}),e.jsxs("div",{className:"space-y-2 pt-2",children:[e.jsxs(me,{onClick:Ct,className:"w-full",children:[e.jsx(it,{className:"w-4 h-4 mr-2"}),b.filter(t=>t.selected).length," Artikel zur Liste"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(me,{variant:"outline",onClick:St,className:"flex-1",children:[e.jsx(Ot,{className:"w-4 h-4 mr-1"}),"Speichern"]}),e.jsxs(me,{variant:"outline",onClick:At,className:"flex-1",children:[e.jsx(Ut,{className:"w-4 h-4 mr-1"}),"Zu Finanzen"]})]})]})]})})]}),!Me&&!$e&&e.jsxs("div",{className:"fixed right-4 bottom-20 flex flex-col gap-3 safe-bottom",children:[e.jsx("button",{onClick:Ft,className:"w-12 h-12 rounded-full bg-secondary text-secondary-foreground shadow-lg flex items-center justify-center active:opacity-80 transition-opacity",children:e.jsx(he,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>fe(!0),className:"w-14 h-14 rounded-full bg-primary text-primary-foreground shadow-lg flex items-center justify-center active:opacity-80 transition-opacity",children:e.jsx(it,{className:"w-6 h-6"})})]})]})}export{os as M};
